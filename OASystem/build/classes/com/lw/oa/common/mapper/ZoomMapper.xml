<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
    PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN"
    "http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">
    
<mapper namespace="common.zoom">
	<!-- Modal查询员工信息 -->    
	<select id="searchEmpList" resultType="resultCommand" parameterType="java.util.Map">
	<![CDATA[
		SELECT 
			t.empid, t.empname, ROW_NUMBER() OVER(order by t.entrytime) as rownum 
		FROM [dbo].[t_empinfo] t
		where t.deletefg = '0' and t.status = '0' 
	]]> 
		<if test="empname!=null and empname!=''">
			and t.empname like '%'+#{empname}+'%'
		</if>
		<if test="orgcdid!=null and orgcdid!=''">
			and t.empid in (select empid from t_emporg where orgcdid = #{orgcdid})
		</if>
		<if test="depid!=null and depid!=''">
			and t.empid in (select empid from t_emporg where depid = #{depid})
		</if>	
	</select>
	<!-- Modal查询角色信息 -->    
	<select id="searchRoleList" resultType="resultCommand" parameterType="java.util.Map">
	<![CDATA[
		SELECT 
			t.roleid, t.rolename, ROW_NUMBER() OVER(order by t.rolename) as rownum 
		FROM [dbo].[s_role] t
		where t.deletefg = '0'
	]]> 
		<if test="rolename!=null and rolename!=''">
			and t.rolename like '%'+#{rolename}+'%'
		</if>
	</select>	 
	<!-- Modal查询日程预约信息 -->    
	<select id="searchDeviceOrderListByPage" resultType="resultCommand" parameterType="deviceOrderSearchCommand">
	<![CDATA[
		SELECT 
			t1.dailydeviceid,t1.orgcdid,org.orgname,org.orgshortname,t1.dailydevicename,
			t1.comment,V1.daily, V1.eventstarttime, V1.eventendtime,
			ROW_NUMBER() OVER(order by t1.orgcdid,t1.dailydevicename,V1.daily desc,V1.eventstarttime) as rownum 
		FROM [dbo].[t_dailydeviceinfo] t1  
		left join [dbo].[s_organize] org 
			on t1.orgcdid = org.orgcdid and t1.deletefg = org.deletefg 
		left join (
			select t2.dailydeviceid, convert(char(10), t4.daily, 23) as daily,convert(char(19), t4.eventstarttime, 120) as eventstarttime,
				convert(char(19), t4.eventendtime, 120) as eventendtime  
			from [dbo].[t_eventdevice] t2  			
			inner join [dbo].[t_event] t3 
				on t2.eventid = t3.eventid and t2.deletefg = t3.deletefg 
			inner join [dbo].[t_eventtime] t4 
				on t2.eventid = t4.eventid and t2.deletefg = t4.deletefg 
			where t3.status != '9' and t2.deletefg = '0' 
	]]>
		<if test="displaydate!=null and displaydate!=''">
			and convert(char(10), t4.daily, 23) = #{displaydate}
		</if>
		) V1
		on t1.dailydeviceid = V1.dailydeviceid 
		where t1.deletefg = '0'
		<if test="displaydate!=null and displaydate!=''">
			and (V1.daily = #{displaydate} or V1.daily is null)
		</if>
		<if test="devicename !=null and devicename != ''">
			and t1.dailydevicename like '%'+#{devicename}+'%'
		</if>
		<if test="orgcdid!=null and orgcdid!=''">
			and t1.orgcdid = #{orgcdid}
		</if>				
	</select>
	<!-- Modal查询日程设备信息 -->    
	<select id="searchDeviceList" resultType="resultCommand" parameterType="java.util.Map">
	<![CDATA[
		SELECT 
			t.dailydeviceid,t.orgcdid,org.orgname,org.orgshortname,t.dailydevicename,
			t.comment,ROW_NUMBER() OVER(order by t.orgcdid,t.dailydevicename) as rownum 
		FROM [dbo].[t_dailydeviceinfo] t 
		left join [dbo].[s_organize] org 
			on t.orgcdid = org.orgcdid 
		where t.deletefg = '0' 
	]]> 
		<if test="dailydevicename!=null and dailydevicename!=''">
			and t.dailydevicename like '%'+#{dailydevicename}+'%'
		</if>
		<if test="orgcdid!=null and orgcdid!=''">
			and t.orgcdid = #{orgcdid}
		</if>		
	</select>	
	<!-- Modal查询机构信息 -->    
	<select id="searchOrgList" resultType="resultCommand" parameterType="java.util.Map">
	<![CDATA[
		SELECT 
			t.orgcdid, t.orgname, t.orgshortname, t.regionid, dict1.busidictname as regioniddict,
			ROW_NUMBER() OVER(order by t.regionid,t.orgname) as rownum 
		FROM [dbo].[s_organize] t 
		left join [dbo].[s_busidict] dict1 
			on t.regionid = dict1.busidictid and dict1.busidicttypeid = 'OA_COMMON_Region' 
		where t.deletefg = '0' 
	]]> 
		<if test="regionid!=null and regionid!=''">
			and t.regionid = #{regionid}
		</if>
		<if test="orgname!=null and orgname!=''">
			and t.orgname = #{orgname}
		</if>		
	</select>
	<!-- 根据empid查询组织机构 -->    
	<select id="searchOrgsByEmpid" resultType="resultCommand" parameterType="java.util.Map">
	<![CDATA[
		SELECT 
			t.empid, t.orgcdid, t1.orgname, t1.orgshortname, t.depid, dict1.busidictname as depiddict, t.posid, dict2.busidictname as posiddict
		from [dbo].[t_emporg] t 
		inner join [dbo].[s_organize] t1 
			on t.orgcdid = t1.orgcdid and t.deletefg = t1.deletefg 
		left join [dbo].[s_busidict] dict1 
			on t.depid = dict1.busidictid and dict1.busidicttypeid = 'OA_COMMON_Department' 
		left join [dbo].[s_busidict] dict2 
			on t.posid = dict2.busidictid and dict2.busidicttypeid = 'OA_COMMON_Position' 
 		where t.deletefg = '0' and t.empid = #{empid}
	]]>		
	</select>
	<!-- 根据empid查询角色 -->    
	<select id="searchRolesByEmpid" resultType="resultCommand" parameterType="java.util.Map">
	<![CDATA[
		SELECT 
			t.empid, t.roleid, t1.rolename
		from [dbo].[t_emprole] t 
		inner join [dbo].[s_role] t1 
			on t.roleid = t1.roleid and t.deletefg = t1.deletefg 
 		where t.deletefg = '0' and t.empid = #{empid}
	]]>		
	</select>
</mapper>